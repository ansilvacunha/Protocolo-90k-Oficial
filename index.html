<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Protocolo 90K - Rei Anderson</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        'prot-black': '#121212',
                        'prot-dark': '#1E1E1E',
                        'prot-gray': '#2D2D2D',
                        'prot-orange': '#FF6B00',
                        'prot-orange-dark': '#CC5500',
                        'prot-red': '#EF4444',
                        'prot-green': '#10B981',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #121212; color: #E5E5E5; -webkit-tap-highlight-color: transparent; }
        .card { background-color: #1E1E1E; border: 1px solid #2D2D2D; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
        input, button { outline: none; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #1E1E1E; }
        ::-webkit-scrollbar-thumb { background: #2D2D2D; border-radius: 2px; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        @keyframes pulse-red { 0% { background-color: rgba(239, 68, 68, 0.1); } 50% { background-color: rgba(239, 68, 68, 0.3); } 100% { background-color: rgba(239, 68, 68, 0.1); } }
        .animate-alert { animation: pulse-red 2s infinite; }

        /* Graph Utilities */
        .chart-line { fill: none; stroke: #FF6B00; stroke-width: 2; vector-effect: non-scaling-stroke; }
        .chart-dot { fill: #1E1E1E; stroke: #FF6B00; stroke-width: 2; r: 4; }
        .chart-area { fill: rgba(255, 107, 0, 0.1); }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "recharts": "https://aistudiocdn.com/recharts@^3.5.1",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.556.0"
  }
}
</script>
</head>
<body class="pb-12 select-none">

    <!-- TOAST DE GAMIFICA√á√ÉO -->
    <div id="toast" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 hidden opacity-0 transition-opacity duration-300">
        <div class="text-center transform scale-100">
            <div class="text-6xl mb-4">üèÜ</div>
            <h2 class="text-3xl font-black text-white italic uppercase">Boa, Rei!</h2>
            <p class="text-prot-green font-semibold mt-2 text-lg">Meta Batida.</p>
        </div>
    </div>

    <!-- HEADER -->
    <header className="sticky top-0 z-20 bg-prot-dark/95 backdrop-blur border-b border-prot-gray shadow-xl">
        <div class="max-w-md mx-auto px-4 py-4 flex justify-between items-center">
            <div>
                <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-0.5">Protocolo 90K</p>
                <h1 class="text-xl font-black italic text-white leading-tight">
                    Rei <span class="text-prot-orange">Anderson</span>
                </h1>
            </div>
            <div class="text-right">
                <div class="flex gap-3 text-[10px] font-mono text-gray-400 mb-1">
                    <span>META: 90kg</span>
                    <span>TETO: 1750kcal</span>
                </div>
                <div class="flex items-baseline justify-end gap-2">
                    <span id="header-weight" class="text-xl font-bold text-white">--kg</span>
                    <span id="header-cals" class="text-xs px-2 py-0.5 rounded bg-gray-800 text-gray-400 font-mono">-- kcal</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto px-4 pt-6 space-y-6">

        <!-- 1. NUTRI√á√ÉO -->
        <section class="card p-5 animate-fade-in">
            <div class="mb-4">
                <h3 class="text-gray-400 text-xs font-bold uppercase tracking-wider flex items-center gap-2 mb-3">
                    <!-- Icon Utensils -->
                    <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    Gest√£o de Combust√≠vel
                </h3>
                
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <span id="nutri-current" class="text-3xl font-bold text-white">0</span>
                        <span class="text-gray-500 text-sm"> / 1750 kcal</span>
                    </div>
                    <div id="nutri-status" class="text-xs font-mono text-gray-400">Restam: --</div>
                </div>

                <div class="h-3 w-full bg-prot-gray rounded-full overflow-hidden">
                    <div id="nutri-bar" class="h-full bg-blue-500 transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>

            <!-- Card√°pio T√°tico -->
            <div class="grid gap-2 mb-4" id="meal-list">
                <!-- Injetado via JS -->
            </div>

            <!-- Input Manual -->
            <div class="bg-black/20 p-3 rounded-lg border border-prot-gray flex gap-2">
                <input id="extra-desc" type="text" placeholder="Extra (ex: Chocolate)" class="flex-1 bg-prot-gray text-white text-sm rounded px-3 py-2 border border-transparent focus:border-prot-orange">
                <input id="extra-cals" type="number" placeholder="Kcal" class="w-20 bg-prot-gray text-white text-sm rounded px-3 py-2 border border-transparent focus:border-prot-orange">
                <button onclick="addExtra()" class="bg-gray-700 hover:bg-prot-orange text-white px-3 rounded transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                </button>
            </div>
            
            <!-- Hist√≥rico Recente -->
            <div id="nutri-history" class="mt-3 pt-3 border-t border-prot-gray space-y-1 hidden">
                <p class="text-[10px] text-gray-500 uppercase font-bold mb-2">Hoje</p>
                <!-- Items -->
            </div>
        </section>

        <!-- 2. HIDRATA√á√ÉO -->
        <section class="card p-5 animate-fade-in" style="animation-delay: 0.1s">
            <div class="flex justify-between items-end mb-4">
                <div>
                    <h3 class="text-gray-400 text-xs font-bold uppercase tracking-wider flex items-center gap-2">
                        <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
                        Hidrata√ß√£o
                    </h3>
                    <p class="text-3xl font-bold text-white mt-1">
                        <span id="water-current">0.0</span> <span class="text-lg text-gray-500">/ 4L</span>
                    </p>
                </div>
                <div id="water-pct" class="text-prot-orange font-bold text-xl">0%</div>
            </div>

            <div class="h-3 w-full bg-prot-gray rounded-full overflow-hidden mb-6">
                <div id="water-bar" class="h-full bg-blue-500 transition-all duration-500 relative" style="width: 0%">
                    <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="addWater(250)" class="bg-prot-gray hover:bg-gray-700 active:bg-gray-600 text-white py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                    + 250ml
                </button>
                <button onclick="addWater(500)" class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2 shadow-lg shadow-blue-900/20">
                    + 500ml
                </button>
            </div>
        </section>

        <!-- 3. MEDICAMENTOS -->
        <section class="card p-5 animate-fade-in" style="animation-delay: 0.2s">
            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-wider flex items-center gap-2 mb-5">
                <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
                Protocolo Manipulados
            </h3>
            <div id="med-list" class="space-y-6">
                <!-- Injetado via JS -->
            </div>
        </section>

        <!-- 4. PESO -->
        <section class="card p-5 animate-fade-in" style="animation-delay: 0.3s">
            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-4">Evolu√ß√£o Peso</h3>
            
            <!-- SVG Graph Container -->
            <div class="w-full h-40 bg-black/20 rounded border border-prot-gray mb-4 relative overflow-hidden" id="weight-chart-container">
                <!-- SVG gerado dinamicamente -->
            </div>

            <form onsubmit="addWeight(event)" class="flex gap-2">
                <div class="relative flex-1">
                    <input id="weight-input" type="number" step="0.1" placeholder="Novo peso (kg)" class="w-full pl-3 pr-3 py-3 bg-prot-gray text-white border border-transparent focus:border-prot-orange rounded-lg">
                </div>
                <button type="submit" class="bg-prot-orange hover:bg-prot-orange-dark text-white font-bold px-5 rounded-lg">
                    Salvar
                </button>
            </form>
        </section>

        <!-- RESET MANUAL -->
        <div class="text-center pt-6">
            <button onclick="forceReset()" class="text-[10px] text-gray-600 hover:text-prot-red flex items-center justify-center gap-1 mx-auto">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                RESETAR DIA (DEBUG)
            </button>
        </div>

    </main>

    <script>
        // --- CONSTANTS & CONFIG ---
        const GOALS = {
            WEIGHT: 90,
            WATER: 4000, // ml
            CALORIES: 1750, // kcal
            START_WEIGHT: 106
        };

        const MEALS = [
            { 
                id: 'caf√©', 
                label: 'Caf√© da Manh√£', 
                desc: '3 Ovos Mexidos + 1 fatia P√£o Integral + Azeite', 
                cals: 350,
                alert: false 
            },
            { 
                id: 'almo√ßo', 
                label: 'Almo√ßo', 
                desc: '200g Carne Magra + 80g Arroz + 100g Feij√£o', 
                cals: 600,
                alert: true // F√≥rmula 2
            },
            { 
                id: 'lanche', 
                label: 'Lanche Tarde', 
                desc: '1 Dose Whey + 1 Fruta ou Iogurte', 
                cals: 250,
                alert: false 
            },
            { 
                id: 'jantar', 
                label: 'Jantar', 
                desc: '200g Carne/Frango + 1 Batata M√©dia (SEM FEIJ√ÉO)', 
                cals: 550,
                alert: true // F√≥rmula 2
            }
        ];

        const MEDS_CONFIG = {
            morning: { label: 'Manh√£ (F√≥rmula 1)', meds: ['Cafe√≠na', 'Citrus', 'Ioimbina'] },
            lunch: { label: 'Almo√ßo/Jantar (F√≥rmula 2)', meds: ['Glucomannan', 'Psyllium'] },
            night: { label: 'Noite (F√≥rmula 3)', meds: ['Morosil', 'Relora'] }
        };

        // --- STATE MANAGEMENT ---
        let state = {
            water: 0,
            lastActiveDate: new Date().toDateString(),
            medications: [], // Array of {id, name, group, taken}
            weightHistory: [],
            nutritionHistory: []
        };

        // --- INIT ---
        function init() {
            const saved = localStorage.getItem('proto90k_vanilla_v1');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };
                } catch(e) { console.error("Erro load", e); }
            } else {
                // First run setup
                seedMeds();
                state.weightHistory.push({ date: new Date().toISOString(), weight: GOALS.START_WEIGHT });
            }

            checkDailyReset();
            renderAll();
        }

        function seedMeds() {
            let meds = [];
            Object.keys(MEDS_CONFIG).forEach(group => {
                MEDS_CONFIG[group].meds.forEach((name, idx) => {
                    meds.push({
                        id: `${group}-${idx}`,
                        name: name,
                        group: group,
                        taken: false
                    });
                });
            });
            state.medications = meds;
        }

        function checkDailyReset() {
            const today = new Date().toDateString();
            if (state.lastActiveDate !== today) {
                // Reset daily counters
                state.water = 0;
                state.medications.forEach(m => m.taken = false);
                state.lastActiveDate = today;
                save();
            }
        }

        function save() {
            localStorage.setItem('proto90k_vanilla_v1', JSON.stringify(state));
            renderAll();
        }

        function renderAll() {
            renderNutrition();
            renderWater();
            renderMeds();
            renderWeight();
            renderHeader();
        }

        // --- RENDERERS ---

        function renderHeader() {
            const currentWeight = state.weightHistory.length > 0 ? state.weightHistory[state.weightHistory.length-1].weight : GOALS.START_WEIGHT;
            const diff = currentWeight - GOALS.START_WEIGHT;
            const weightEl = document.getElementById('header-weight');
            
            weightEl.innerText = `${currentWeight}kg`;
            weightEl.className = `text-xl font-bold ${diff <= 0 ? 'text-prot-green' : 'text-prot-red'}`;
        }

        function renderNutrition() {
            // Filter today
            const todayStr = new Date().toDateString();
            const todayLog = state.nutritionHistory.filter(n => new Date(n.date).toDateString() === todayStr);
            const totalCals = todayLog.reduce((acc, curr) => acc + curr.cals, 0);

            // Bar
            const barEl = document.getElementById('nutri-bar');
            const pct = Math.min((totalCals / GOALS.CALORIES) * 100, 100);
            barEl.style.width = `${pct}%`;
            
            // Colors logic
            const statusEl = document.getElementById('nutri-status');
            const currentEl = document.getElementById('nutri-current');
            
            if (totalCals > GOALS.CALORIES) {
                barEl.className = 'h-full bg-prot-red transition-all duration-500 animate-pulse';
                statusEl.innerHTML = '<span class="text-prot-red font-bold flex items-center gap-1">‚ö†Ô∏è LIMITE EXCEDIDO</span>';
                currentEl.className = 'text-3xl font-bold text-prot-red';
            } else {
                barEl.className = pct > 85 ? 'h-full bg-prot-orange transition-all duration-500' : 'h-full bg-blue-500 transition-all duration-500';
                statusEl.innerHTML = `Restam: <span class="text-white font-bold">${GOALS.CALORIES - totalCals}</span>`;
                currentEl.className = 'text-3xl font-bold text-white';
            }
            
            currentEl.innerText = totalCals;

            // List Buttons
            const listEl = document.getElementById('meal-list');
            listEl.innerHTML = '';
            
            MEALS.forEach(meal => {
                const count = todayLog.filter(l => l.mealId === meal.id).length;
                const isDone = count > 0;
                
                const btn = document.createElement('button');
                btn.className = `w-full flex items-start justify-between p-3 rounded-lg border text-left transition-all relative overflow-hidden group ${isDone ? 'bg-gray-800/50 border-gray-700' : 'bg-black/30 border-gray-800 hover:bg-gray-800'}`;
                btn.onclick = () => addMeal(meal);

                let alertHtml = '';
                if(meal.alert) {
                    alertHtml = `<span class="ml-2 text-[9px] bg-purple-900/50 text-purple-300 px-1.5 py-0.5 rounded border border-purple-800 flex items-center gap-1 inline-flex"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg> F√ìRMULA 2</span>`;
                }

                btn.innerHTML = `
                    ${isDone ? '<div class="absolute left-0 top-0 bottom-0 w-1 bg-prot-green"></div>' : ''}
                    <div class="flex-1 pr-2 z-10">
                        <div class="flex items-center flex-wrap">
                            <span class="font-bold text-gray-200">${meal.label}</span>
                            ${alertHtml}
                        </div>
                        <p class="text-xs text-gray-500 mt-1 leading-snug">${meal.desc}</p>
                    </div>
                    <div class="flex flex-col items-end z-10">
                        <span class="text-prot-orange font-bold text-sm">${meal.cals}</span>
                        <span class="text-[10px] text-gray-600">kcal</span>
                        ${isDone ? `<span class="text-[10px] text-prot-green mt-1">‚úì Feito (${count})</span>` : ''}
                    </div>
                `;
                listEl.appendChild(btn);
            });

            // History List
            const historyEl = document.getElementById('nutri-history');
            if(todayLog.length > 0) {
                historyEl.classList.remove('hidden');
                let html = '<p class="text-[10px] text-gray-500 uppercase font-bold mb-2">Hist√≥rico Hoje</p>';
                todayLog.forEach(item => {
                    html += `
                        <div class="flex justify-between items-center text-xs p-1 hover:bg-white/5 rounded group">
                            <span class="text-gray-400 truncate w-2/3">${item.name}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-300">${item.cals}</span>
                                <button onclick="removeNutrition('${item.id}')" class="text-gray-600 hover:text-prot-red"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                            </div>
                        </div>
                    `;
                });
                historyEl.innerHTML = html;
            } else {
                historyEl.classList.add('hidden');
            }
            
            // Header calc update
            document.getElementById('header-cals').innerText = `${totalCals} kcal`;
            document.getElementById('header-cals').className = `text-xs px-2 py-0.5 rounded font-mono ${totalCals > GOALS.CALORIES ? 'bg-red-900 text-red-200' : 'bg-gray-800 text-gray-400'}`;
        }

        function renderWater() {
            const pct = Math.min((state.water / GOALS.WATER) * 100, 100);
            document.getElementById('water-current').innerText = (state.water / 1000).toFixed(1) + 'L';
            document.getElementById('water-pct').innerText = pct.toFixed(0) + '%';
            document.getElementById('water-bar').style.width = `${pct}%`;
        }

        function renderMeds() {
            const container = document.getElementById('med-list');
            container.innerHTML = '';
            
            ['morning', 'lunch', 'night'].forEach(groupKey => {
                const groupConfig = MEDS_CONFIG[groupKey];
                const groupMeds = state.medications.filter(m => m.group === groupKey);
                
                const allTaken = groupMeds.every(m => m.taken);
                
                const wrapper = document.createElement('div');
                wrapper.innerHTML = `
                    <div class="flex items-center gap-2 mb-2">
                        <h4 class="text-xs font-bold uppercase tracking-wider ${allTaken ? 'text-prot-green' : 'text-gray-500'}">
                            ${groupConfig.label}
                        </h4>
                        ${allTaken ? '<svg class="w-4 h-4 text-prot-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>' : ''}
                    </div>
                    <div class="space-y-2">
                        ${groupMeds.map(med => `
                            <button onclick="toggleMed('${med.id}')" class="w-full flex items-center justify-between p-3 rounded-lg border transition-all duration-200 ${med.taken ? 'bg-green-900/20 border-green-900/50 text-green-100' : 'bg-prot-gray border-transparent hover:bg-gray-700 text-gray-300'}">
                                <span class="font-medium text-sm">${med.name}</span>
                                ${med.taken 
                                    ? '<svg class="w-5 h-5 text-prot-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                                    : '<svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>'
                                }
                            </button>
                        `).join('')}
                    </div>
                `;
                container.appendChild(wrapper);
            });
        }

        function renderWeight() {
            const container = document.getElementById('weight-chart-container');
            const data = state.weightHistory;
            
            if (data.length < 2) {
                container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500 text-xs">Adicione mais dados para ver o gr√°fico</div>';
                return;
            }

            // Simple normalization for SVG
            const weights = data.map(d => d.weight);
            const minW = Math.min(...weights, GOALS.WEIGHT) - 1;
            const maxW = Math.max(...weights) + 1;
            const rangeW = maxW - minW;
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // Generate points
            const points = data.map((d, i) => {
                const x = (i / (data.length - 1)) * width;
                const y = height - ((d.weight - minW) / rangeW) * height;
                return `${x},${y}`;
            }).join(' ');

            // Goal Line Y
            const goalY = height - ((GOALS.WEIGHT - minW) / rangeW) * height;

            // SVG Construction
            const svg = `
                <svg width="100%" height="100%" viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
                    <!-- Goal Line -->
                    <line x1="0" y1="${goalY}" x2="${width}" y2="${goalY}" stroke="#10B981" stroke-width="1" stroke-dasharray="4" opacity="0.5" />
                    <text x="${width - 5}" y="${goalY - 5}" fill="#10B981" font-size="10" text-anchor="end">Meta</text>
                    
                    <!-- Graph Line -->
                    <polyline points="${points}" class="chart-line" />
                    
                    <!-- Dots -->
                    ${data.map((d, i) => {
                        const x = (i / (data.length - 1)) * width;
                        const y = height - ((d.weight - minW) / rangeW) * height;
                        return `<circle cx="${x}" cy="${y}" class="chart-dot" />`;
                    }).join('')}
                </svg>
            `;
            
            container.innerHTML = svg;
        }

        // --- ACTIONS ---

        function addWater(amount) {
            const oldVal = state.water;
            state.water += amount;
            
            // Gamification check
            if (oldVal < GOALS.WATER && state.water >= GOALS.WATER) {
                showToast();
            }
            save();
        }

        function addMeal(meal) {
            state.nutritionHistory.push({
                id: Date.now().toString(),
                mealId: meal.id,
                name: meal.label,
                cals: meal.cals,
                date: new Date().toISOString()
            });
            save();
        }

        function addExtra() {
            const desc = document.getElementById('extra-desc').value;
            const cals = parseInt(document.getElementById('extra-cals').value);
            
            if (desc && cals > 0) {
                state.nutritionHistory.push({
                    id: Date.now().toString(),
                    mealId: 'extra',
                    name: `Extra: ${desc}`,
                    cals: cals,
                    date: new Date().toISOString()
                });
                
                // Clear inputs
                document.getElementById('extra-desc').value = '';
                document.getElementById('extra-cals').value = '';
                save();
            }
        }

        function removeNutrition(id) {
            if(confirm('Remover este item?')) {
                state.nutritionHistory = state.nutritionHistory.filter(i => i.id !== id);
                save();
            }
        }

        function toggleMed(id) {
            const med = state.medications.find(m => m.id === id);
            if (med) {
                med.taken = !med.taken;
                save();
            }
        }

        function addWeight(e) {
            e.preventDefault();
            const val = parseFloat(document.getElementById('weight-input').value);
            if (val > 0) {
                state.weightHistory.push({
                    date: new Date().toISOString(),
                    weight: val
                });
                document.getElementById('weight-input').value = '';
                save();
            }
        }

        function forceReset() {
            if(confirm('Isso vai zerar √°gua e rem√©dios de HOJE. Confirma?')) {
                state.water = 0;
                state.medications.forEach(m => m.taken = false);
                save();
            }
        }

        function showToast() {
            const toast = document.getElementById('toast');
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('opacity-100');
                toast.classList.remove('opacity-0');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        // Run
        window.onload = init;

    </script>
</body>
</html>
